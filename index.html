<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gift Games Order</title>
  <link rel="stylesheet" href="css/styles.css">
  <script src="js/generateJsonFile.js"></script>
</head>
<body>
  <div class="photo-editor">
    <!-- Step 1: Game Selection -->
    <div class="order-form">
      <h1 id="step1Title">1. Selected Game</h1>
      <p>‚ö†Ô∏è Select the game you want to customize from the menu below.</p>
      <div class="game-menu" id="gameMenu"></div>
      <input type="hidden" id="gameSelect" value="">
      <div class="notification" id="notification"></div>
    </div>

    <!-- Step 2: Player Photo -->
    <div class="order-form">
      <h1 id="step2Title">2. Player Photo</h1>
      <p>‚ö†Ô∏è Select a photo of the person you want to customize the game for. Adjust the photo to fit the face contour below.</p>
      <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="updateStep2Status(); previewPhoto()">
      <div class="canvas-container" style="position: relative; width: 380px; height: 380px;">
        <canvas id="photoCanvas"></canvas>
        <img id="overlayImage" src="Resources/avatar-mask.png" alt="Overlay" />
      </div>
      <p>‚ö†Ô∏è Use the tools to edit your photo.</p>
      <div class="controls">
        <button title="Rotate Left" onclick="rotateImage(-10)">‚ü≤</button>
        <button title="Rotate Right" onclick="rotateImage(10)">‚ü≥</button>
        <button title="Zoom In" onclick="zoomImage(1.1)">üîç+</button>
        <button title="Zoom Out" onclick="zoomImage(0.9)">üîç-</button>
        <button title="Flip Photo" onclick="flipPhoto()">‚áã</button>
        <button title="Reset" onclick="resetTransformations()">‚Ü∫</button>
        <button title="Add Image" type="button" onclick="document.getElementById('photoInput').click()">‚ûï</button>
      </div>
    </div>

    <!-- Step 3: Player Details -->
    <div class="order-form">
      <h1 id="step3Title">3. Player Details</h1>
      <p>‚ö†Ô∏è Enter the name and email address of the person for whom the game is being customized.</p>
      <input type="text" id="name" placeholder="Name" required oninput="updateStep3Status(false)">
      <input type="email" id="email" placeholder="Email" required oninput="validateEmail()">
      <div id="emailError" style="color: red; font-size: 14px; display: none;">Invalid email format</div>
    </div>

    <!-- Step 4: Payment Details -->
    <div class="order-form">
      <h1 id="step4Title">4. Payment Details</h1>
      <p>‚ö†Ô∏è Review the total price and place your order to complete the customization process.</p>
      <div class="order-summary">
        <h1>Payment</h1>
        <div class="summary-details">
          <p><strong>Total Price:</strong> <span id="totalPrice">20.00$</span></p>
        </div>
        <button class="payment-button" id="placeOrderButton" type="button" onclick="placeOrder()" disabled>Place Order</button>
      </div>
    </div>
  </div>

  <!-- Popup Notification -->
  <div id="popup" class="popup" style="display: none;">
    <div class="popup-content">
      <p>Your order has been placed successfully! üéâ</p>
      <button onclick="closePopup()">OK</button>
    </div>
  </div>

  <script src="js/scripts.js"></script>
  <script>
    const games = [
      { id: 'G1', name: 'Game 1 (G1)', icon: 'Resources/G1.png', overlayImage: 'Resources/avatar-mask-G1.png' },
      { id: 'G2', name: 'Game 2 (G2)', icon: 'Resources/G2.png', overlayImage: 'Resources/avatar-mask-G2.png' },
      { id: 'G3', name: 'Game 3 (G3)', icon: 'Resources/G3.png', overlayImage: 'Resources/avatar-mask-G3.png' },
      { id: 'G4', name: 'Game 4 (G4)', icon: 'Resources/G4.png', overlayImage: 'Resources/avatar-mask-G4.png' }
    ];

    function renderGameMenu() {
      const gameMenu = document.getElementById('gameMenu');
      gameMenu.innerHTML = ''; // Clear existing content

      games.forEach(game => {
        const gameOption = document.createElement('div');
        gameOption.className = 'game-option';
        gameOption.id = `game${game.id}`;
        gameOption.onclick = () => selectGame(game.id, gameOption.id);

        const gameIcon = document.createElement('img');
        gameIcon.src = game.icon;
        gameIcon.alt = `${game.name} Icon`;

        const gameName = document.createElement('span');
        gameName.textContent = game.name;

        gameOption.appendChild(gameIcon);
        gameOption.appendChild(gameName);
        gameMenu.appendChild(gameOption);
      });
    }

    function validateEmail() {
      const emailInput = document.getElementById('email');
      const emailError = document.getElementById('emailError');
      const emailPattern = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/i;

      if (emailInput.value && !emailPattern.test(emailInput.value)) {
        emailError.style.display = 'block';
        updateStep3Status(false); // Mark step 3 as incomplete
      } else {
        emailError.style.display = 'none';
        updateStep3Status(true); // Mark step 3 as complete
      }
      checkAllStepsCompleted();
    }

    function updateStep1Status() {
      const gameSelect = document.getElementById('gameSelect');
      const step1Title = document.getElementById('step1Title');
      if (gameSelect.value) {
        step1Title.textContent = '1. ‚úÖ Selected Game';
      } else {
        step1Title.textContent = '1. Selected Game';
      }
      checkAllStepsCompleted();
    }

    function updateStep2Status() {
      const photoInput = document.getElementById('photoInput');
      const step2Title = document.getElementById('step2Title');
      if (photoInput.files.length > 0) {
        step2Title.textContent = '2. ‚úÖ Player Photo';
      } else {
        step2Title.textContent = '2. Player Photo';
      }
      checkAllStepsCompleted();
    }

    function updateStep3Status(isEmailValid) {
      const step3Title = document.getElementById('step3Title');
      if (isEmailValid) {
        step3Title.textContent = '3. ‚úÖ Player Details';
      } else {
        step3Title.textContent = '3. Player Details';
      }
      checkAllStepsCompleted();
    }

    function checkAllStepsCompleted() {
      const gameSelect = document.getElementById('gameSelect').value;
      const photoInput = document.getElementById('photoInput').files.length > 0;
      const emailInput = document.getElementById('email');
      const emailPattern = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/i;
      const isEmailValid = emailPattern.test(emailInput.value);

      const placeOrderButton = document.getElementById('placeOrderButton');
      if (gameSelect && photoInput && isEmailValid) {
        placeOrderButton.disabled = false;
      } else {
        placeOrderButton.disabled = true;
      }
    }

    function placeOrder() {
      // Show popup
      const popup = document.getElementById('popup');
      popup.style.display = 'block';

      // Update step 4 title
      const step4Title = document.getElementById('step4Title');
      step4Title.textContent = '4. ‚úÖ Payment Details';

      generateAndSendJSON();
    }

    function closePopup() {
      const popup = document.getElementById('popup');
      popup.style.display = 'none';
    }

    function selectGame(gameId, elementId) {
      const gameSelect = document.getElementById('gameSelect');
      gameSelect.value = gameId;

      const step1Title = document.getElementById('step1Title');
      step1Title.textContent = `1. ‚úÖ Selected Game (${gameId})`;

      // Remove the "selected" class from all game options
      document.querySelectorAll('.game-option').forEach(option => {
        option.classList.remove('selected');
      });

      // Add the "selected" class to the clicked game option
      const selectedOption = document.getElementById(elementId);
      selectedOption.classList.add('selected');

      // Update the overlay image based on the selected game
      const selectedGame = games.find(game => game.id === gameId);
      const overlayImage = document.getElementById('overlayImage');
      overlayImage.src = selectedGame.overlayImage;

      // Update the URL with the selected game
      const newUrl = `${window.location.origin}${window.location.pathname}?current-game=${gameId}`;
      window.history.pushState({ path: newUrl }, '', newUrl);

      checkAllStepsCompleted();
    }

    function autoSelectGameFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const currentGame = urlParams.get('current-game');
      if (currentGame) {
        const game = games.find(g => g.id === currentGame);
        if (game) {
          selectGame(game.id, `game${game.id}`);
        }
      }
    }

    renderGameMenu(); // Render the game menu
    autoSelectGameFromURL(); // Automatically select the game based on the URL
  </script>
</body>
</html>